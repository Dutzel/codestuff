-module(cmem).
-import(werkzeug, [getUTC/0]).
-export([deleteExpired/1, initCMEM/2, getClientNNr/2, updateClient/4]).

%Die Nummern in den Kommentaren beziehen sich auf:
%Das Diagramm "Serverkomponente"

%ToDo: Loggen.
initCMEM(RemTime, Datei) ->
	[RemTime, []].

%10.) Ist Client neu?  Wenn Client nicht in Liste enthalten ist, dann 1. zurückgeben.
%12.) Älteste Nachrichtennummer zum absenden markieren = NNr 1.
getClientNNr([RemTime, []], _ClientID) ->
	1;
getClientNNr([RemTime, [[Pid, _NNr, _LastVisit] | Rest]], ClientID) when Pid /= ClientID ->
	getClientNNr([RemTime, Rest], ClientID);
%11.) Nächste Nachrichtennummer zum absenden markieren = NNr + 1 zurückgeben.
getClientNNr([RemTime, [[_Pid, NNr, _LastVisit] | _Rest]], _ClientID) ->
	NNr + 1.

%Update des Clients.
%RemTime = Clientlifetime.
updateClient([RemTime, []], ClientID, NNr, Datei) -> %Client neu & erster Client überhaupt.-> speichern.
	[RemTime, [[ClientID, 1, getUTC()]]];
updateClient([RemTime, Clients], ClientID, NNr, Datei) -> % Client suchen.
	Result = updateClient(Clients, ClientID, NNr, Datei, search),
	[RemTime] ++ [Result].

%Hilfsfunktion zur Suche des Clients.
updateClient([], ClientID, NNr, Datei, search) -> %Client neu -> speichern.
	[[ClientID, NNr, getUTC()]];	
updateClient([[Pid, NNr2, Timestamp] | Rest], ClientID, NNr, Datei, search) when Pid == ClientID-> %Client gefunden.
	[[Pid, NNr, getUTC()]] ++ Rest;
updateClient([[Pid, NNr2, Timestamp] | Rest], ClientID, NNr, Datei, search) -> %Client noch nicht gefunden -> weitersuchen.
	[[Pid, NNr, getUTC()]] ++ updateClient(Rest, ClientID, NNr, Datei, search).

%
deleteExpired([RemTime, Cmem]) ->
	deleteExpired(RemTime, Cmem).
deleteExpired(_RemTime, []) ->
	[];
deleteExpired(RemTime, [[ClientPid, NNr, LastVisit] | Rest]) ->
	case (werkzeug:getUTC() - LastVisit)/1000 > RemTime of
		true ->
			deleteExpired(RemTime, Rest);
		false ->	
		[[ClientPid, NNr, LastVisit]] ++ deleteExpired(RemTime, Rest)
	end.
